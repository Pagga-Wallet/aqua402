global
    maxconn 4096
    log stdout format raw local0 info
    
defaults
    log     global
    mode    tcp
    option  tcplog
    option  dontlognull
    retries 3
    timeout connect 5s
    timeout client  1m
    timeout server  1m

# ClickHouse HTTP port (8123)
frontend clickhouse_http
    bind *:8123
    mode http
    option httplog
    default_backend clickhouse_http_nodes

backend clickhouse_http_nodes
    mode http
    balance roundrobin
    option httpchk
    http-check send meth GET uri /ping ver HTTP/1.1 hdr Host localhost
    http-check expect status 200
    server clickhouse-1 clickhouse-1:8123 check inter 2s fall 3 rise 2
    server clickhouse-2 clickhouse-2:8123 check inter 2s fall 3 rise 2
    server clickhouse-3 clickhouse-3:8123 check inter 2s fall 3 rise 2
    server clickhouse-4 clickhouse-4:8123 check inter 2s fall 3 rise 2

# ClickHouse Native port (9000)
frontend clickhouse_native
    bind *:9000
    mode tcp
    default_backend clickhouse_native_nodes

backend clickhouse_native_nodes
    mode tcp
    balance roundrobin
    option tcp-check
    server clickhouse-1 clickhouse-1:9000 check inter 2s fall 3 rise 2
    server clickhouse-2 clickhouse-2:9000 check inter 2s fall 3 rise 2
    server clickhouse-3 clickhouse-3:9000 check inter 2s fall 3 rise 2
    server clickhouse-4 clickhouse-4:9000 check inter 2s fall 3 rise 2

# HAProxy statistics
listen stats
    bind *:8404
    mode http
    stats enable
    stats uri /stats
    stats refresh 10s
    stats admin if TRUE
